<!DOCTYPE html>
    <head>
        <!-- Spotify CSS files -->
        <style>
        @import url('$views/css/buttons.css');
        @import url('$views/css/image.css');
        @import url('$views/css/list.css');
      </style>
        <!-- Project CSS files -->
        <link rel="stylesheet" type="text/css" href="css/main.css">
    </head>
    <body>
        <div id="wrapper">
            <div id="index" class="section">
                <h1>MyTunes Library</h1>
                <input type="text" name="lfm-name" id="lfm-name" placeholder="Last.fm Username" />
                <button id="hit-lfm">Get Music</button>
                <span id="lfmFail" style="color:red"></span>
                <h1>Top Music:</h1>
                <select style="width:50%" id="artistSelect" size="8">
                </select>
                <select id="albumSelect" style="width:49%" size="8">
                </select>
                <div id="multiple-tracks-player"></div><div id="multiple-tracks-list"></div>

            </div>
        </div>
        <script src="/js/jquery.js"></script>
        <script src="/js/underscore.js"></script>
        <script type="text/javascript">
          require(['$api/models', '$views/list#List', '$api/search#Search'], function(models, List, Search) {
          // referenced classes: views.player, models.player, views.list, models.search, models.album, models.library
          var musicData;
          var myAlbum;
          //console.log(List);
         // , Albumlist;
          $(document).ready(function(){
              // api key 1c73c492595e398bb2ee64465c67026a
              var loadLFM = function(userName){
              $.ajax({
                "url" : "http://ws.audioscrobbler.com/2.0/?method=user.gettopalbums&user="+userName+"&api_key=1c73c492595e398bb2ee64465c67026a&format=json&limit=200",
                "dataType": "json",
                "success": function(data){
                  if (data.error) {
                    $("#lfmFail").html(data.message);
                    return;
                  }
                  else if (data.topalbums.total === "0") { 
                    $("#lfmFail").html("No music found for "+data.topalbums.user);
                    return;
                  } else {
                    $("#lfmFail").html("");
                  }
                  // reset data
                  musicData = {
                    artists: {}
                  }
                  $("#artistSelect").html("<option value='all'>All</option>");
                  $.each(data.topalbums.album, function(k,v){
                    if (musicData.artists[v.artist.name]){
                      musicData.artists[v.artist.name].push(v.name);
                    } else {
                    musicData.artists[v.artist.name] = [v.name];
                    }
                    $("#topalbums").append("<li>"+v.artist.name+" - "+v.name+"</li>"); 
                  });
                  _.chain(musicData.artists).keys().sort().each(function(v){$("#artistSelect").append('<option value="'+v+'">'+v+'</option>')});
                  console.log(musicData);
                  selectArtist("all");
                  $('#artistSelect').on('change', function() {
                    selectArtist(this.value);
                  });
                  $('#albumSelect').on('change', function() {
                    console.log("searching for "+this.value);
                    searchAlbum(this.value);
                  });
                  $("#albumSelect").on('dblclick', function(){
                   console.log(currList); 
                   setTimeout(function(){models.player.playTrackWithContext(false, myAlbum, -1)}, 200);
                  });
                }

              });
              };
              // todo load from localStorage instead of hitting LFM
              loadLFM("Yono");
              $("#hit-lfm").click(function(){ loadLFM( $("#lfm-name").val() ) });

              var selectArtist = function(artist){
                $("#albumSelect").html("");
                var albums;
                if (artist == "all"){
                  albums = _.chain(musicData.artists).values().flatten();
                } else {
                  albums = musicData.artists[artist]; 
                }
                var allAlbums = _.chain(albums).sort().value();
                _.each(allAlbums, function(k,v){
                  $("#albumSelect").append('<option value="'+k+'">'+k+'</option>');
                });
              };
              var searchAlbum = function(searchTerm, artistName){
                // definitely TODO cache this shit
                var searchResult = Search.search(searchTerm);
                console.log(searchResult);
                searchResult.albums.snapshot(0, 2).done(function(snapshot) {
                  console.log('Found', snapshot.length, 'result(s) for', searchResult.query);
                  if (snapshot.length == 0) {
            //    $("#multiple-tracks-list").html("No Results");
                  $("#multiple-tracks-list").html("No albums found for "+searchResult.query);
                  return;
                  }
                  //console.log('Here are the first 2:');
                  snapshot.loadAll('name').done(function(albums) {
//                    console.log(albums[0].uri);
                    addList(albums[0]);
             //       /* albums.forEach(function(album) {
             //         console.log(album);
             //         console.log(album.name, album.uri, album.artists[0].name);
            //        }); */
                  });
                });
              }; 
              var loadAlbum = function(uri){
                addList(uri);
                return;
                console.log("loading album");
                var myAlbum = models.Album.fromURI(uri);
                console.log(uri);
                var currList = List.forAlbum(myAlbum);
               // currList.node.classList.add('sp-light');
               // $("#multiple-tracks-list").html("");
              //  document.getElementById('multiple-tracks-list').appendChild(currList.node);
               document.body.appendChild(currList.node);
                currList.init();
              };
              var loadSpotify = function(uri){
                var usrAlbums = _.groupBy(models.library.albums, function(v){ return v.data.artist.name })
              }
              var addList = function(uri){
                console.log(uri);
                $("#multiple-tracks-list").html("Testing");
            //    if (uri){
           //       var album = models.Album.fromURI(uri);
           //     } else {
           //       var album = models.Album.fromURI('spotify:album:5fTBlCZFI4zYOdJn1NrLgt');
           //     }
            //    setTimeout(function(){
                var Albumlist = List.forAlbum(uri);
                console.log(Albumlist);
                document.getElementById('multiple-tracks-list').appendChild(Albumlist.node);
                Albumlist.init();
                //Albumlist.refresh();
                console.log(Albumlist);
          //      }, 200);
              }
              var newList = function(uri){
                var album = models.Album.fromURI(uri);
                console.log(Albumlist);
                console.log(Albumlist.setItem);
                console.log(Albumlist._oldParentNode);
                document.getElementById('multiple-tracks-list').appendChild(Albumlist._oldParentNode);
                Albumlist.init();
             //   Albumlist.refresh();
                //Albumlist.more();
              //  console.log(Albumlist);

              }
              var testList = function(){
                var album = models.Album.fromURI('spotify:album:6iBEe3qEjdIRz38swH7jT0');
                console.log(album);
                var list = List.forAlbum(album);
                document.body.appendChild(list.node);
                list.init();
                var al2 = models.Album.fromURI('spotify:album:5fTBlCZFI4zYOdJn1NrLgt');
                list.setItem(al2);
              }
            //  testList();
            //  addList('spotify:album:5fTBlCZFI4zYOdJn1NrLgt');
            });
            });
          </script>
    </body>
</html>
